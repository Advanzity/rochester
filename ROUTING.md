# Netlify Routing Configuration

This document explains how the app's routing is configured for Netlify serverless deployment to ensure all pages are accessible via direct URL without 404 errors.

## Overview

The app uses a combination of:
1. **netlify.toml** - Main configuration for Netlify
2. **public/_redirects** - Netlify redirect rules
3. **next.config.js** - Next.js configuration
4. **tsconfig.json** - TypeScript exclusions

## Direct URL Access

All pages are accessible via direct URLs:

### Application Pages
- `https://yourdomain.com/` - Home page
- `https://yourdomain.com/gold-scrap` - Gold scrap pricing page
- `https://yourdomain.com/market-board` - Market dashboard

### API Endpoints (Netlify Functions)
- `https://yourdomain.com/api/scrap-prices` - GET all prices
- `https://yourdomain.com/api/scrap-prices/{id}` - PATCH/DELETE specific price
- `https://yourdomain.com/.netlify/functions/get-gold-spot-price` - Get live spot price
- `https://yourdomain.com/.netlify/functions/update-scrap-prices` - Update all prices

## Configuration Files

### 1. netlify.toml

Located at project root, this file configures:

**Build Settings:**
```toml
[build]
  command = "npm run build"
  publish = ".next"
```

**Netlify Plugin:**
```toml
[[plugins]]
  package = "@netlify/plugin-nextjs"
```

**Functions Directory:**
```toml
[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"
```

**Routing Rules:**
- API routes redirect to Netlify Functions
- Page routes map to HTML files
- Next.js assets served correctly
- Catch-all for client-side routing

**Security Headers:**
- X-Frame-Options
- X-Content-Type-Options
- X-XSS-Protection
- Referrer-Policy
- Permissions-Policy

**Cache Headers:**
- Static assets cached for 1 year
- Fonts and images optimized

### 2. public/_redirects

Simple redirect rules that Netlify reads during deployment:

```
/api/*  /.netlify/functions/:splat  200
/  /index.html  200
/gold-scrap  /gold-scrap.html  200
/market-board  /market-board.html  200
/_next/*  /_next/:splat  200
/*  /index.html  200
```

**Important:** The catch-all `/*` redirect MUST be last for proper fallback behavior.

### 3. next.config.js

Configured for Netlify deployment:

```javascript
{
  trailingSlash: false,
  skipTrailingSlashRedirect: true,
  images: { unoptimized: true }
}
```

- `trailingSlash: false` - URLs work without trailing slashes
- `skipTrailingSlashRedirect: true` - Prevents unnecessary redirects
- `images: { unoptimized: true }` - Required for static export

### 4. tsconfig.json

Excludes function directories from TypeScript compilation:

```json
{
  "exclude": ["node_modules", "supabase/functions", "netlify/functions"]
}
```

This prevents TypeScript errors when building Next.js app.

## How Routing Works

### Page Requests

1. User visits `https://yourdomain.com/gold-scrap`
2. Netlify checks redirect rules in order
3. Matches `/gold-scrap` → `/gold-scrap.html`
4. Serves the static HTML file generated by Next.js
5. React hydrates the page for interactivity

### API Requests

1. Frontend calls `/api/scrap-prices`
2. Netlify matches `/api/*` redirect rule
3. Routes to `/.netlify/functions/scrap-prices`
4. Serverless function executes
5. Response returned to client

### 404 Prevention

The catch-all redirect `/* → /index.html` ensures:
- Unknown routes fall back to the main app
- React Router can handle client-side routing
- No 404 errors for valid client-side routes
- Single Page App (SPA) behavior preserved

## Netlify Functions

Functions are stored in `netlify/functions/` directory:

### get-gold-spot-price.ts
- **Method:** GET
- **URL:** `/.netlify/functions/get-gold-spot-price`
- **Purpose:** Fetch live gold spot prices from external APIs

### update-scrap-prices.ts
- **Method:** POST
- **URL:** `/.netlify/functions/update-scrap-prices`
- **Purpose:** Update all scrap prices in database

### scrap-prices.ts
- **Methods:** GET, POST, PATCH, DELETE
- **URL:** `/.netlify/functions/scrap-prices`
- **Purpose:** CRUD operations for scrap pricing

## Testing Routes Locally

### Using Netlify Dev

```bash
npm install -g netlify-cli
netlify dev
```

This simulates Netlify's environment locally, including:
- Redirect rules
- Function routing
- Environment variables
- Build process

### Test Each Route

1. **Home:** `http://localhost:8888/`
2. **Gold Scrap:** `http://localhost:8888/gold-scrap`
3. **Market Board:** `http://localhost:8888/market-board`
4. **API:** `http://localhost:8888/api/scrap-prices`

All should load without 404 errors.

## Deployment Checklist

Before deploying, verify:

- [ ] `netlify.toml` is in project root
- [ ] `public/_redirects` exists and is correct
- [ ] `next.config.js` has correct settings
- [ ] `netlify/functions/` directory contains all functions
- [ ] `tsconfig.json` excludes function directories
- [ ] Build completes successfully (`npm run build`)
- [ ] Environment variables are set in Netlify dashboard

## Troubleshooting

### 404 on Direct Page Access

**Problem:** Navigating to `/gold-scrap` returns 404

**Solution:**
- Check `netlify.toml` has page redirects
- Verify `_redirects` file is in `public/` directory
- Ensure catch-all redirect is LAST in the list

### API Routes Don't Work

**Problem:** `/api/scrap-prices` returns 404

**Solution:**
- Verify function exists in `netlify/functions/`
- Check API redirect rule in `netlify.toml`
- Review function logs in Netlify dashboard

### Build Fails with TypeScript Errors

**Problem:** Build fails complaining about Netlify functions

**Solution:**
- Add `netlify/functions` to `tsconfig.json` exclude list
- Run `npm run build` to verify

### Functions Return CORS Errors

**Problem:** Browser shows CORS errors when calling functions

**Solution:**
- Verify each function has CORS headers
- Check OPTIONS method is handled
- Ensure `Access-Control-Allow-Origin: *` is set

## Additional Resources

- [Netlify Redirects Documentation](https://docs.netlify.com/routing/redirects/)
- [Netlify Functions Documentation](https://docs.netlify.com/functions/overview/)
- [Next.js on Netlify](https://docs.netlify.com/integrations/frameworks/next-js/)
- [@netlify/plugin-nextjs](https://github.com/netlify/netlify-plugin-nextjs)

## Summary

The routing configuration ensures:
- ✅ All pages accessible via direct URL
- ✅ No 404 errors on page refresh
- ✅ API routes work seamlessly
- ✅ Client-side navigation preserved
- ✅ SEO-friendly URLs
- ✅ Serverless functions auto-scale
- ✅ Static assets optimally cached
